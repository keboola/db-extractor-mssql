sudo: required

services:
  - docker

install:
  - docker-compose -v
  - docker-compose build
  - docker-compose run --rm app

script:
  - docker pull quay.io/keboola/developer-portal-cli-v2:latest
  - export REPOSITORY=`docker run --rm -e KBC_DEVELOPERPORTAL_USERNAME -e KBC_DEVELOPERPORTAL_PASSWORD quay.io/keboola/developer-portal-cli-v2:latest ecr:get-repository keboola keboola.ex-db-mssql`
  - docker tag keboola/ex-db-mssql:latest $REPOSITORY:master
  - eval $(docker run --rm -e KBC_DEVELOPERPORTAL_USERNAME -e KBC_DEVELOPERPORTAL_PASSWORD quay.io/keboola/developer-portal-cli-v2:latest ecr:get-login keboola keboola.ex-db-mssql)
  - docker push $REPOSITORY:master
  # Run live test job on new master image
  - docker pull quay.io/keboola/syrup-cli:latest
  - travis_wait docker run --rm -e KBC_STORAGE_TOKEN quay.io/keboola/syrup-cli:latest run-job keboola.ex-db-mssql 287615945 master
  - travis_wait docker run --rm -e KBC_STORAGE_TOKEN quay.io/keboola/syrup-cli:latest run-job keboola.ex-db-mssql 287628364 master


deploy:
  provider: script
  skip_cleanup: true
  script: "./deploy.sh"
  on:
    tags: true

notifications:
  slack:
    secure: szvbdaYk1YBTSyvBJN2PAaZX9PrgBdToMckDaBEwGb6q+/kLIDkcBTWSsCgp4kqTklVbDzZOx/UsMDAsZQFLP9p2L5I3ylVdFK7Ri6scn+loCHW7vJ2E+rW8jV/TevCRKHgYbBMc9FHW9e6cQnsCQxqHR3zX69dqiImWUKNYoFmlIQU8CSBtfN7f21FrB+5WPSWxgcR+Lj+/TMkvgn8BL2zFwIFaD+PMNbrI7gaIXEKfbI9FM3wl2uWWMO854dPsHPa29ZsbLV1nPmXDCg5T0hOlZdW8AzmNK/LY709ee8VW377HF1iKWgIsy96gzrgujsxRImZT6aVDEX4/Ajam4wpHkt/ZAUa014XZydTqle2iUu94IaziazXyW+tyKXKgR8w50DpgqfAJtRl9R1Uw7OrQlwzPvfr3Aa8v+PINOhQx116Zk04Ptsb2FfvoQqSMtjIVOMU6FA03SHFZ4lhED3FoevxsxMpzF4c8iW+CEkqugVM8JxRDHrCwheBjZaGCBscUd35YqvhcD62bsFMgPi5x6kqpG5FL66yVSz3+/U5wahcMumY4YgeV71D4fKHMd43Kfujubmk1xR2rMdY+Nv5MijXqcG2TK1vL8PhHk2pDqORi0GXozKkA6/vtSG2jn2+Jk4XDLIYrr9+6RfAZ9ZbB+vpsLsNnzX10INNQiAg=
