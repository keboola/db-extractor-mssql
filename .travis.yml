sudo: required

services:
  - docker

install:
  - docker-compose -v
  - docker-compose build
  - docker-compose run --rm app

script:
  - docker pull quay.io/keboola/developer-portal-cli-v2:latest
  - export REPOSITORY=`docker run --rm -e KBC_DEVELOPERPORTAL_USERNAME -e KBC_DEVELOPERPORTAL_PASSWORD quay.io/keboola/developer-portal-cli-v2:latest ecr:get-repository keboola keboola.ex-db-mssql`
  - docker tag keboola/ex-db-mssql:latest $REPOSITORY:master
  - eval $(docker run --rm -e KBC_DEVELOPERPORTAL_USERNAME -e KBC_DEVELOPERPORTAL_PASSWORD quay.io/keboola/developer-portal-cli-v2:latest ecr:get-login keboola keboola.ex-db-mssql)
  - docker push $REPOSITORY:master
  # Run live test job on new master image
  - docker pull quay.io/keboola/syrup-cli:latest
  - travis_wait docker run --rm -e KBC_STORAGE_TOKEN quay.io/keboola/syrup-cli:latest run-job keboola.ex-db-mssql 287615945 master
  - travis_wait docker run --rm -e KBC_STORAGE_TOKEN quay.io/keboola/syrup-cli:latest run-job keboola.ex-db-mssql 287628364 master
  # Run a test on sql server 2008
  - travis_wait docker run --rm -e KBC_STORAGE_TOKEN quay.io/keboola/syrup-cli:latest run-job keboola.ex-db-mssql 402532849 master
  # Test Azure DB
  #- travis_wait docker run --rm -e KBC_STORAGE_TOKEN quay.io/keboola/syrup-cli:latest run-job keboola.ex-db-mssql
  # 430354652 master

deploy:
  provider: script
  skip_cleanup: true
  script: "./deploy.sh"
  on:
    tags: true

notifications:
  slack:
    secure: OLvASu4VxdV2/+ZXW4OYCirL/xxPvoztr4Mq6AmjvU0gxpowGZh+4UyGi4eoRCrO0KxeNm4tLeCU6TI/rKDb6va0zJ7HBCIT6OIA5rdvVS3V0gA1WZTOY3Rrm2A7ON+jv8WPUnX/wn8J2/LYjwT53PN/p3SQzZiJNNf3Q5MgV0t4jRDOT0d2XvozJuLtDeruAC1Kt6xLpbfHQI3CQIhWXpnzevngQHZeUReJ6wSE5UzHGXc66I2LJDAYi4+OK52NKxlDcIzu3fOrmyWwuysJ+hETaRDnmQUrmEsyhhl1zfWOaTnWO1RvA/8c5L9H79Ss2N04LnpE21GabTKmIW/6ZvnNOONc4aHFyYenIRITid9x2wBP+9IsBRkyd+nOylqkiVNOaha4jn/87x0a2yxsbfZqFzSsweuWoKPwbwm8gF7+Fv0VScwL6nIKme4RLU6J4WzO85UQYhm4LBEuCQMqj8PB1NTR93WDP0PyvCB8PakEflBMEH/INiR/fhWdk0po1TCSsWHMhkeaImvo0olfR41xMSTuywVSfi5ifkq/RzJGEVG36t21sPsrM1ytiGDzXfx0mOSNW6zjm/tHcApKbkO/g9sHK2yKgUUBZkkRdHl+NqDhN/oGLbnq+DmrXwroCE9GyWU1W7QgIP6Yz7P7O5pAWEAi6+u8V0jCTJwu9gA=
